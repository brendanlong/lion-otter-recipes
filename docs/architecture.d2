# Lion+Otter Recipes - Architecture Diagram

direction: down

title: {
  label: Lion+Otter Recipes Architecture
  near: top-center
  shape: text
  style: {
    font-size: 24
    bold: true
  }
}

# External Services
external: {
  label: External Services
  style: {
    fill: "#f0f0f0"
    stroke: "#999"
  }

  anthropic: {
    label: Anthropic API
    shape: rectangle
    style: {
      fill: "#d4a03c"
    }
  }

  web: {
    label: Recipe Websites
    shape: rectangle
  }

  google_drive: {
    label: Google Drive
    shape: rectangle
    style: {
      fill: "#4285f4"
    }
  }
}

# Android App
app: {
  label: Android App
  style: {
    fill: "#e0f2f7"
    stroke: "#2a7b9b"
    stroke-width: 2
  }

  # UI Layer
  ui: {
    label: UI Layer (Compose)
    style: {
      fill: "#fff3e0"
      stroke: "#d4a03c"
    }

    screens: {
      label: Screens
      style: {
        fill: "#ffffff"
      }

      list: RecipeListScreen
      detail: {
        label: RecipeDetailScreen
        tooltip: "Displays recipe details with share button (exports as Markdown via Android share sheet). All text is selectable."
      }
      add: AddRecipeScreen
      settings: SettingsScreen
      import_debug_list: {
        label: ImportDebugListScreen
        tooltip: "Lists all import debug entries with status, timestamp, and model info. Only accessible when import debugging is enabled."
      }
      import_debug_detail: {
        label: ImportDebugDetailScreen
        tooltip: "Tabbed detail view for a single import debug entry. Tabs: Summary (URL, lengths, tokens, model, cost, recipe link), Original Content (HTML with source toggle), Cleaned Content (HTML with source toggle), AI Output (JSON tree view with copy-to-clipboard button). All text is selectable."
      }

      list -> detail: tap recipe
      list -> add: tap +
      list -> settings: tap gear
      add -> settings: no API key
      settings -> import_debug_list: view debug data
      import_debug_list -> import_debug_detail: tap entry
      import_debug_detail -> detail: view recipe
    }

    components: {
      label: Shared Components
      style: {
        fill: "#ffffff"
      }

      top_bar: RecipeTopAppBar
      error_card: ErrorCard
      progress_card: ProgressCard
      status_card: StatusCard
      delete_dialog: DeleteConfirmationDialog
    }

    screens -> components: uses

    viewmodels: {
      label: ViewModels
      style: {
        fill: "#ffffff"
      }

      list_vm: RecipeListViewModel
      detail_vm: RecipeDetailViewModel
      add_vm: AddRecipeViewModel
      settings_vm: SettingsViewModel
      drive_vm: {
        label: GoogleDriveViewModel
        tooltip: "Manages Google Drive sign-in state, folder selection (via folder picker dialog), and sync enable/disable/trigger"
      }
      zip_vm: {
        label: ZipExportImportViewModel
        tooltip: "Manages ZIP file export/import operations via WorkManager. Handles file picker integration and work status observation."
      }
      import_debug_list_vm: {
        label: ImportDebugListViewModel
        tooltip: "Observes all import debug entries from the repository as a StateFlow."
      }
      import_debug_detail_vm: {
        label: ImportDebugDetailViewModel
        tooltip: "Loads a single import debug entry by ID from SavedStateHandle."
      }
    }

    state: {
      label: UI State
      style: {
        fill: "#ffffff"
      }

      in_progress_mgr: {
        label: InProgressRecipeManager
        tooltip: "Tracks recipes currently being imported. Observes WorkManager directly to auto-clean orphaned entries on completion/failure/cancellation, regardless of which screens are active."
      }
    }

    screens.list -> viewmodels.list_vm
    screens.detail -> viewmodels.detail_vm
    screens.add -> viewmodels.add_vm
    screens.settings -> viewmodels.settings_vm
    screens.settings -> viewmodels.drive_vm: sign in/out
    screens.settings -> viewmodels.zip_vm: backup/restore
    screens.import_debug_list -> viewmodels.import_debug_list_vm
    screens.import_debug_detail -> viewmodels.import_debug_detail_vm
    viewmodels.list_vm -> state.in_progress_mgr: observes
    viewmodels.add_vm -> state.in_progress_mgr: adds entries
    state.in_progress_mgr -> background.worker: observes status
  }

  # Background Processing Layer
  background: {
    label: Background Processing
    style: {
      fill: "#f3e5f5"
      stroke: "#9c27b0"
    }

    worker: {
      label: WorkManager
      style: {
        fill: "#ffffff"
      }

      base_worker: {
        label: BaseRecipeWorker
        tooltip: "Abstract base class providing shared foreground notification management and error/unavailable result handling for all recipe workers."
      }
      import_worker: {
        label: RecipeImportWorker
        tooltip: "CoroutineWorker that handles recipe import in background. Survives app closure and shows progress notifications. Supports queue of multiple imports."
      }
      paprika_import_worker: {
        label: PaprikaImportWorker
        tooltip: "Imports recipes from a Paprika export file (.paprikarecipes). Parses ZIP of gzip-compressed JSON, sends content through AI pipeline."
      }
      sync_worker: {
        label: GoogleDriveSyncWorker
        tooltip: "Bidirectional sync with Google Drive. Runs on app startup and periodically (every 6 hours). Uploads new local recipes, downloads new remote recipes, updates changed recipes using latest-timestamp-wins conflict resolution."
      }
      zip_export_worker: {
        label: ZipExportWorker
        tooltip: "Exports all recipes to a ZIP file. Uses the same folder structure as Google Drive export (recipe.json + original.html + recipe.md per recipe)."
      }
      zip_import_worker: {
        label: ZipImportWorker
        tooltip: "Imports recipes from a ZIP file. Reads recipe.json from each folder, skips duplicates, optionally restores original HTML."
      }
      import_worker -> base_worker: extends
      paprika_import_worker -> base_worker: extends
      sync_worker -> base_worker: extends
      zip_export_worker -> base_worker: extends
      zip_import_worker -> base_worker: extends
      work_ext: {
        label: "observeWorkByTag()"
        tooltip: "WorkManager extension function that encapsulates the common pattern of observing work by tag and filtering to a specific work ID. Used by AddRecipeViewModel, GoogleDriveViewModel (sync), and ZipExportImportViewModel."
      }
    }

    notification: {
      label: Notifications
      style: {
        fill: "#ffffff"
      }

      helper: {
        label: RecipeNotificationHelper
        tooltip: "Manages notification channel, foreground info for workers, and shows progress/success/error notifications for recipe imports, Google Drive sync, and ZIP operations"
      }
    }

    worker.import_worker -> notification.helper: notify progress
    worker.paprika_import_worker -> notification.helper: notify progress
    worker.sync_worker -> notification.helper: notify progress
    worker.zip_export_worker -> notification.helper: notify progress
    worker.zip_import_worker -> notification.helper: notify progress
  }

  # Domain Layer
  domain: {
    label: Domain Layer
    style: {
      fill: "#e8f5e9"
      stroke: "#4caf50"
    }

    usecases: {
      label: Use Cases
      style: {
        fill: "#ffffff"
      }

      import: ImportRecipeUseCase
      parse_html: {
        label: ParseHtmlUseCase
        tooltip: "Reusable helper for parsing HTML via AI. Used by URL import."
      }
      import_paprika: {
        label: ImportPaprikaUseCase
        tooltip: "Imports recipes from Paprika export (.paprikarecipes). Parses export, sends recipe content (not source URL) through AI, resolves images from Paprika data or source page. Supports cooperative cancellation â€” checks coroutine state between recipes and preserves already-imported recipes on cancel."
      }
      sync_drive: {
        label: SyncToGoogleDriveUseCase
        tooltip: "Bidirectional sync: compares local vs remote recipes, uploads new, downloads new, updates changed (latest timestamp wins). Runs via WorkManager on startup and periodically."
      }
      export_zip: {
        label: ExportToZipUseCase
        tooltip: "Exports all recipes to a ZIP file using RecipeSerializer. Same folder structure as Google Drive export."
      }
      import_zip: {
        label: ImportFromZipUseCase
        tooltip: "Imports recipes from a ZIP file. Reads recipe.json from each folder, skips duplicates by ID, optionally restores original HTML."
      }
      tags: GetTagsUseCase
      calc_usage: {
        label: CalculateIngredientUsageUseCase
        tooltip: "Pure domain logic for calculating ingredient usage status from checked instruction steps, scale, and measurement preference."
      }
    }

    util: {
      label: Utilities
      style: {
        fill: "#ffffff"
      }

      markdown: {
        label: RecipeMarkdownFormatter
        tooltip: "Converts Recipe to human-readable Markdown format for export"
      }
      serializer: {
        label: RecipeSerializer
        tooltip: "Shared logic for serializing/deserializing recipes in the standard folder export format (recipe.json + original.html + recipe.md). Used by Google Drive sync and ZIP export/import."
      }
      serializer -> markdown: format
    }

    models: {
      label: Domain Models
      style: {
        fill: "#ffffff"
      }

      recipe: {
        label: Recipe
        tooltip: "@Immutable. Fields: id, name, sourceUrl, story, servings, times, ingredients, instructions, tags, imageUrl, timestamps, isFavorite"
      }
      ingredient: {
        label: Ingredient
        tooltip: "@Immutable. Fields: name, notes, alternates, amounts, optional"
      }
      instruction: {
        label: InstructionStep
        tooltip: "@Immutable. Fields: stepNumber, instruction, ingredients, optional"
      }
      section: IngredientSection
      measurement: Measurement
      measurement_type: MeasurementType
      measurement_pref: MeasurementPreference
      usage_status: {
        label: IngredientUsageStatus
        tooltip: "@Immutable. Fields: totalAmount, usedAmount, unit, isFullyUsed, remainingAmount"
      }

      recipe -> section
      section -> ingredient
      ingredient -> ingredient: alternates
      ingredient -> measurement: amounts
      measurement -> measurement_type: type
      recipe -> instruction
      instruction -> ingredient: step ingredients
    }

    usecases.import -> usecases.parse_html: uses
    usecases.parse_html -> data.repository.import_debug_repo: save debug data
    usecases.sync_drive -> util.serializer: serialize
    usecases.export_zip -> util.serializer: serialize
    usecases.import_zip -> util.serializer: deserialize
  }

  # Data Layer
  data: {
    label: Data Layer
    style: {
      fill: "#e3f2fd"
      stroke: "#2196f3"
    }

    repository: {
      label: Repository
      style: {
        fill: "#ffffff"
      }

      repo: RecipeRepository
      import_debug_repo: {
        label: ImportDebugRepository
        tooltip: "CRUD operations for import debug entries. Supports listing all, getting by ID, saving, and deleting all entries."
      }
    }

    local: {
      label: Local Storage
      style: {
        fill: "#ffffff"
      }

      room: {
        label: Room Database
        shape: cylinder
      }
      datastore: {
        label: DataStore
        shape: cylinder
      }
      encrypted_prefs: {
        label: EncryptedSharedPreferences
        shape: cylinder
        tooltip: "AES256-GCM encrypted storage for sensitive data like API keys"
        style: {
          fill: "#c8e6c9"
        }
      }
      dao: RecipeDao
      entity: RecipeEntity
      import_debug_dao: ImportDebugDao
      import_debug_entity: {
        label: ImportDebugEntity
        tooltip: "Room entity storing import debug data: source URL, original/cleaned HTML, AI output JSON, token counts, model, error info, linked recipe ID"
      }
      settings: {
        label: SettingsDataStore
        tooltip: "Uses EncryptedSharedPreferences for API key, DataStore for non-sensitive settings (AI model, extended thinking enabled, keep screen on, theme mode, import debugging enabled, Google Drive sync enabled/folder/last sync timestamp)"
      }

      dao -> room
      entity -> room
      import_debug_dao -> room
      import_debug_entity -> room
      settings -> datastore: non-sensitive settings
      settings -> encrypted_prefs: API key
    }

    remote: {
      label: Remote Services
      style: {
        fill: "#ffffff"
      }

      anthropic_svc: {
        label: AnthropicService
        tooltip: "Uses the Anthropic Java SDK (OkHttp) to parse recipes with volume/weight conversions, step-level ingredient extraction, and optional field detection. Extended thinking is configurable via settings. Supports Opus 4.6, Opus 4.5, Sonnet 4.5, and Haiku 4.5"
      }
      scraper: {
        label: WebScraperService
        tooltip: Uses Readability4J to extract article content
      }
      google_drive_svc: {
        label: GoogleDriveService
        tooltip: "Handles Google Sign-In, folder listing/creation/selection, file upload/download/update/delete for Drive sync"
      }
    }

    paprika: {
      label: Paprika
      style: {
        fill: "#ffffff"
      }

      parser: {
        label: PaprikaParser
        tooltip: "Parses Paprika export files (.paprikarecipes): ZIP of gzip-compressed JSON. Formats recipe content for AI parsing."
      }
      recipe_model: {
        label: PaprikaRecipe
        tooltip: "Data model for Paprika recipe JSON (name, ingredients, directions, notes, categories, photo_data, etc.)"
      }
    }

    repository.repo -> local.dao
    repository.repo -> local.settings
    repository.import_debug_repo -> local.import_debug_dao
  }

  # Performance
  performance: {
    label: Performance
    style: {
      fill: "#fff9c4"
      stroke: "#f9a825"
    }

    baseline_profile: {
      label: Baseline Profiles
      tooltip: "Pre-compiled critical code paths for faster startup and smoother scrolling. Generated via :baselineprofile macrobenchmark module."
    }

    profile_installer: {
      label: ProfileInstaller
      tooltip: "Installs Baseline Profiles at app install time for AOT compilation of critical paths."
    }

    baseline_profile -> profile_installer: generates rules for
  }

  # DI
  di: {
    label: Hilt DI
    style: {
      fill: "#fce4ec"
      stroke: "#e91e63"
    }

    app_module: AppModule
    db_module: DatabaseModule
    net_module: NetworkModule
    worker_module: WorkerModule
  }

  # Connections within app
  ui.viewmodels.list_vm -> data.repository.repo: recipes, delete
  ui.viewmodels.list_vm -> domain.usecases.tags: top tags
  ui.viewmodels.detail_vm -> data.repository.repo: recipe, delete, favorite
  ui.viewmodels.detail_vm -> domain.usecases.calc_usage: ingredient usage
  ui.viewmodels.detail_vm -> data.local.settings: keep screen on
  ui.viewmodels.add_vm -> background.worker: enqueue work
  ui.viewmodels.add_vm -> background.worker.work_ext: observe import
  ui.viewmodels.drive_vm -> background.worker.sync_worker: sync
  ui.viewmodels.drive_vm -> background.worker.work_ext: observe sync
  ui.viewmodels.drive_vm -> data.local.settings: sync settings
  ui.viewmodels.zip_vm -> background.worker.zip_export_worker: export
  ui.viewmodels.zip_vm -> background.worker.zip_import_worker: import
  ui.viewmodels.zip_vm -> background.worker.work_ext: observe export/import
  ui.viewmodels.settings_vm -> data.repository.import_debug_repo: delete debug data
  ui.viewmodels.import_debug_list_vm -> data.repository.import_debug_repo: list entries
  ui.viewmodels.import_debug_detail_vm -> data.repository.import_debug_repo: get entry
  background.worker.import_worker -> domain.usecases.import: execute
  background.worker.paprika_import_worker -> domain.usecases.import_paprika: execute
  background.worker.sync_worker -> domain.usecases.sync_drive: execute
  background.worker.zip_export_worker -> domain.usecases.export_zip: execute
  background.worker.zip_import_worker -> domain.usecases.import_zip: execute
  domain.usecases -> data.repository: access data
  domain.usecases.import_paprika -> data.paprika.parser: parse export
  domain.usecases.import_paprika -> data.remote.anthropic_svc: parse recipe content
  domain.usecases.import_paprika -> data.remote.scraper: fetch source image
  data.remote.scraper -> external.web: fetch HTML
  data.remote.anthropic_svc -> external.anthropic: parse recipe
  data.remote.google_drive_svc -> external.google_drive: sync files
}

# Data Flow Legend
legend: {
  label: Data Flow
  near: bottom-center
  style: {
    fill: "#f5f5f5"
  }

  import_flow: {
    label: "URL Import Flow"
    style: {
      font-size: 14
      bold: true
    }
  }
  flow1: "1. User pastes URL and taps Import"
  flow2: "2. ViewModel enqueues WorkManager job"
  flow3: "3. RecipeImportWorker runs as foreground service"
  flow4: "4. Scraper fetches HTML, AI parses recipe"
  flow5: "5. Repository saves to Room"

  flow1 -> flow2 -> flow3 -> flow4 -> flow5

  drive_flow: {
    label: "Google Drive Sync Flow"
    style: {
      font-size: 14
      bold: true
    }
  }
  drive1: "User selects existing folder or creates new one via folder picker dialog"
  drive2: "Bidirectional sync on startup + every 6 hours (latest timestamp wins)"
  drive3: "Uploads new local recipes, downloads new remote recipes, updates changed"

  drive1 -> drive2 -> drive3

  zip_flow: {
    label: "ZIP Export/Import Flow"
    style: {
      font-size: 14
      bold: true
    }
  }
  zip1: "Export: User picks save location, ZipExportWorker writes ZIP with same folder structure as Drive"
  zip2: "Import: User picks .zip file, ZipImportWorker reads recipe.json from each folder"
  zip3: "Uses RecipeSerializer shared with Google Drive for consistent format"
  zip4: "Skips recipes that already exist locally (by ID)"

  zip1 -> zip2 -> zip3 -> zip4

  paprika_flow: {
    label: "Paprika Import Flow"
    style: {
      font-size: 14
      bold: true
    }
  }
  pap1: "1. User picks .paprikarecipes file"
  pap2: "2. PaprikaImportWorker parses ZIP of gzip-compressed JSON"
  pap3: "3. Each recipe's content (not source URL) sent to AI"
  pap4: "4. Image resolved from Paprika data or source page"
  pap5: "5. Repository saves each parsed recipe to Room"

  pap1 -> pap2 -> pap3 -> pap4 -> pap5

  note: {
    label: "Import runs in background via WorkManager. Supports multiple concurrent imports. Google Drive sync, ZIP export/import, and Paprika import run in background with progress notifications. Sync runs on app startup and every 6 hours when enabled. Paprika import can be cancelled mid-way, keeping already-imported recipes. ZIP export uses the same folder format as sync via RecipeSerializer."
    style: {
      font-size: 12
      italic: true
    }
  }

  favorites: {
    label: "Favorites Feature"
    style: {
      font-size: 14
      bold: true
    }
  }
  fav1: "Recipes can be starred/favorited from list or detail view"
  fav2: "Favorites are sorted first in the recipe list"
  fav3: "Re-sorting only occurs on filter/search/ID-set changes via runningFold"

  fav1 -> fav2 -> fav3
}
