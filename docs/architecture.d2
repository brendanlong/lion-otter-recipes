# Lion+Otter Recipes - Architecture Diagram

direction: down

title: {
  label: Lion+Otter Recipes Architecture
  near: top-center
  shape: text
  style: {
    font-size: 24
    bold: true
  }
}

# External Services
external: {
  label: External Services
  style: {
    fill: "#f0f0f0"
    stroke: "#999"
  }

  anthropic: {
    label: Anthropic API
    shape: rectangle
    style: {
      fill: "#d4a03c"
    }
  }

  web: {
    label: Recipe Websites
    shape: rectangle
  }

  google_drive: {
    label: Google Drive
    shape: rectangle
    style: {
      fill: "#4285f4"
    }
  }
}

# Android App
app: {
  label: Android App
  style: {
    fill: "#e0f2f7"
    stroke: "#2a7b9b"
    stroke-width: 2
  }

  # UI Layer
  ui: {
    label: UI Layer (Compose)
    style: {
      fill: "#fff3e0"
      stroke: "#d4a03c"
    }

    screens: {
      label: Screens
      style: {
        fill: "#ffffff"
      }

      list: RecipeListScreen
      detail: RecipeDetailScreen
      add: AddRecipeScreen
      settings: SettingsScreen

      list -> detail: tap recipe
      list -> add: tap +
      list -> settings: tap gear
      add -> settings: no API key
    }

    viewmodels: {
      label: ViewModels
      style: {
        fill: "#ffffff"
      }

      list_vm: RecipeListViewModel
      detail_vm: RecipeDetailViewModel
      add_vm: AddRecipeViewModel
      settings_vm: SettingsViewModel
      drive_vm: {
        label: GoogleDriveViewModel
        tooltip: "Manages Google Drive sign-in state, folder navigation, and continuous sync configuration"
      }
    }

    state: {
      label: UI State
      style: {
        fill: "#ffffff"
      }

      in_progress_mgr: {
        label: InProgressRecipeManager
        tooltip: "Tracks recipes currently being imported, shows them in recipe list while import is in progress"
      }
    }

    screens.list -> viewmodels.list_vm
    screens.list -> viewmodels.drive_vm: sync menu
    screens.detail -> viewmodels.detail_vm
    screens.add -> viewmodels.add_vm
    screens.settings -> viewmodels.settings_vm
    screens.settings -> viewmodels.drive_vm: sign in/out, sync config
    viewmodels.list_vm -> state.in_progress_mgr: observes
    viewmodels.add_vm -> state.in_progress_mgr: updates
  }

  # Background Processing Layer
  background: {
    label: Background Processing
    style: {
      fill: "#f3e5f5"
      stroke: "#9c27b0"
    }

    worker: {
      label: WorkManager
      style: {
        fill: "#ffffff"
      }

      import_worker: {
        label: RecipeImportWorker
        tooltip: "CoroutineWorker that handles recipe import in background. Survives app closure and shows progress notifications. Supports queue of multiple imports."
      }
      sync_worker: {
        label: DriveSyncWorker
        tooltip: "Handles continuous sync with Google Drive. Runs on startup, after recipe changes, and periodically. Processes uploads and detects remote changes via changes.list API."
      }
      delete_worker: {
        label: DriveDeleteWorker
        tooltip: "Handles version-safe deletes from Google Drive. Checks file version before deleting to prevent deleting externally modified files."
      }
    }

    notification: {
      label: Notifications
      style: {
        fill: "#ffffff"
      }

      helper: {
        label: ImportNotificationHelper
        tooltip: "Manages notification channel and shows progress/success/error notifications for recipe imports and sync operations"
      }
    }

    worker.import_worker -> notification.helper: notify progress
    worker.sync_worker -> notification.helper: notify sync status
    worker.delete_worker -> notification.helper: notify progress
  }

  # Sync Layer
  sync: {
    label: Sync Layer
    style: {
      fill: "#e1f5fe"
      stroke: "#03a9f4"
    }

    manager: {
      label: DriveSyncManager
      tooltip: "Coordinates all sync operations. Queues uploads/deletes, executes operations with version checking, auto-imports new recipes with duplicate detection, handles conflicts."
      style: {
        fill: "#ffffff"
      }
    }

    state: {
      label: Sync State
      style: {
        fill: "#ffffff"
      }

      synced_recipe: {
        label: SyncedRecipeEntity
        tooltip: "Tracks sync relationship: local recipe ID <-> Drive folder/file IDs, version info for conflict detection"
      }
      sync_state: {
        label: SyncStateEntity
        tooltip: "Global sync config: enabled flag, sync folder, changes.list page token for incremental sync"
      }
      pending_ops: {
        label: PendingSyncOperationEntity
        tooltip: "Queue of pending operations with retry tracking and version info for safe deletes"
      }
    }

    manager -> state.synced_recipe
    manager -> state.sync_state
    manager -> state.pending_ops
  }

  # Domain Layer
  domain: {
    label: Domain Layer
    style: {
      fill: "#e8f5e9"
      stroke: "#4caf50"
    }

    usecases: {
      label: Use Cases
      style: {
        fill: "#ffffff"
      }

      import: ImportRecipeUseCase
      parse_html: {
        label: ParseHtmlUseCase
        tooltip: "Reusable helper for parsing HTML via AI. Used by URL import."
      }
      get_all: GetRecipesUseCase
      get_one: GetRecipeByIdUseCase
      delete: DeleteRecipeUseCase
      tags: GetTagsUseCase
    }

    util: {
      label: Utilities
      style: {
        fill: "#ffffff"
      }

      markdown: {
        label: RecipeMarkdownFormatter
        tooltip: "Converts Recipe to human-readable Markdown format for export"
      }
    }

    models: {
      label: Domain Models
      style: {
        fill: "#ffffff"
      }

      recipe: Recipe
      ingredient: {
        label: Ingredient
        tooltip: "Fields: name, notes, alternates, amounts, optional"
      }
      instruction: {
        label: InstructionStep
        tooltip: "Fields: stepNumber, instruction, ingredients, optional"
      }
      section: IngredientSection
      measurement: Measurement
      measurement_type: MeasurementType
      measurement_pref: MeasurementPreference

      recipe -> section
      section -> ingredient
      ingredient -> ingredient: alternates
      ingredient -> measurement: amounts
      measurement -> measurement_type: type
      recipe -> instruction
      instruction -> ingredient: step ingredients
    }

    usecases.import -> usecases.parse_html: uses
  }

  # Data Layer
  data: {
    label: Data Layer
    style: {
      fill: "#e3f2fd"
      stroke: "#2196f3"
    }

    repository: {
      label: Repository
      style: {
        fill: "#ffffff"
      }

      repo: {
        label: RecipeRepository
        tooltip: "Central data access. Triggers sync operations on save/delete via SyncTrigger callback."
      }
    }

    local: {
      label: Local Storage
      style: {
        fill: "#ffffff"
      }

      room: {
        label: Room Database
        shape: cylinder
      }
      datastore: {
        label: DataStore
        shape: cylinder
      }
      dao: RecipeDao
      entity: RecipeEntity
      settings: SettingsDataStore
      sync_daos: {
        label: Sync DAOs
        tooltip: "SyncedRecipeDao, SyncStateDao, PendingSyncOperationDao"
      }

      dao -> room
      entity -> room
      sync_daos -> room
      settings -> datastore
    }

    remote: {
      label: Remote Services
      style: {
        fill: "#ffffff"
      }

      anthropic_svc: {
        label: AnthropicService
        tooltip: "Uses extended thinking to parse recipes with volume/weight conversions, step-level ingredient extraction, and optional field detection. Supports Opus 4.5, Sonnet 4.5, and Haiku 4.5"
      }
      scraper: {
        label: WebScraperService
        tooltip: Uses Readability4J to extract article content
      }
      google_drive_svc: {
        label: GoogleDriveService
        tooltip: "Handles Google Sign-In, folder operations, file upload/download, and changes.list API for sync"
      }
    }

    repository.repo -> local.dao
    repository.repo -> local.settings
  }

  # DI
  di: {
    label: Hilt DI
    style: {
      fill: "#fce4ec"
      stroke: "#e91e63"
    }

    app_module: AppModule
    db_module: DatabaseModule
    net_module: NetworkModule
    worker_module: WorkerModule
  }

  # Connections within app
  ui.viewmodels.add_vm -> background.worker: enqueue work
  ui.viewmodels.drive_vm -> sync.manager: configure sync
  background.worker.import_worker -> domain.usecases.import: execute
  background.worker.sync_worker -> sync.manager: execute operations
  background.worker.delete_worker -> sync.manager: execute deletes
  sync.manager -> data.repository.repo: access recipes
  sync.manager -> data.remote.google_drive_svc: upload/download/delete
  data.repository.repo -> sync.manager: queue sync
  domain.usecases -> data.repository: access data
  data.remote.scraper -> external.web: fetch HTML
  data.remote.anthropic_svc -> external.anthropic: parse recipe
  data.remote.google_drive_svc -> external.google_drive: sync files
}

# Data Flow Legend
legend: {
  label: Data Flow
  near: bottom-center
  style: {
    fill: "#f5f5f5"
  }

  import_flow: {
    label: "URL Import Flow"
    style: {
      font-size: 14
      bold: true
    }
  }
  flow1: "1. User pastes URL and taps Import"
  flow2: "2. ViewModel enqueues WorkManager job"
  flow3: "3. RecipeImportWorker runs as foreground service"
  flow4: "4. Scraper fetches HTML, AI parses recipe"
  flow5: "5. Repository saves to Room, triggers sync"

  flow1 -> flow2 -> flow3 -> flow4 -> flow5

  drive_flow: {
    label: "Google Drive Continuous Sync"
    style: {
      font-size: 14
      bold: true
    }
  }
  drive1: "1. User enables sync and selects a Drive folder"
  drive2: "2. Recipe save/delete queues sync operation"
  drive3: "3. DriveSyncWorker processes pending operations"
  drive4: "4. Auto-imports new recipes with duplicate detection"
  drive5: "5. Version checking prevents conflicts"

  drive1 -> drive2 -> drive3 -> drive4 -> drive5

  note: {
    label: "Sync is local-first: local changes are source of truth. New recipes from other devices are auto-imported (duplicates skipped by ID). Deletes check file version before executing."
    style: {
      font-size: 12
      italic: true
    }
  }
}
